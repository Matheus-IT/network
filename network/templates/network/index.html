{% extends "network/layout.html" %}

{% load static %}

{% block otherStatics %}
    <script src="{% static 'network/styles/js/indexForStyles.js' %}"></script>
    <script type="text/javascript">
        var currentNavigationPage;
        var isUserAuthenticated = convertPythonBooleanToJsBoolean('{{ user.is_authenticated }}');

        function convertPythonBooleanToJsBoolean(input) {
			try {
				if (input === 'False')
	        		return false;
				else if (input === 'True')
					return true;
				else
					throw 'Invalid argument';
			} catch(err) {
				console.log(`Error: ${err}`);
			}
        }

        document.addEventListener('DOMContentLoaded', function() {
            // navigate to the first page when first time
            navigateTo(1);
            markAsActive(currentNavigationPage);
            
            document.querySelectorAll('.page-number').forEach((pageNum) => {
                pageNum.addEventListener('click', handlePaginationByNumbers);
            });

            document.querySelector('#previousPage').addEventListener('click', handlePaginateToPreviousPage);
            document.querySelector('#nextPage').addEventListener('click', handlePaginateToNextPage);
        });

        function handlePaginateToPreviousPage() {
            currentNavigationPage--;
            navigateTo(currentNavigationPage);

            deactivateAllPageItems('.page-item');
            markAsActive(currentNavigationPage);
        }

        function markAsActive(currentPageNumber) {
            navigationNumberButtons = document.querySelectorAll('.page-number');

            navigationNumberButtons.forEach(pageNumButton => {
                if (pageNumButton.innerHTML == currentPageNumber) {
                    pageNumButton.parentNode.classList.add('active');
                    return;
                }
            });
        }

        function handlePaginateToNextPage() {
            currentNavigationPage++;
            navigateTo(currentNavigationPage);

            deactivateAllPageItems('.page-item');
            markAsActive(currentNavigationPage);
        }

        function fetchPostsPage(pageNumber=1) {
            fetch(`/getPostsPage/${pageNumber}`)
            .then(response => response.json())
            .then(postsPage => {
                generatePosts(postsPage.currentPagePosts);

                handleHideShow(postsPage.hasPrevious, 'previousPage');
                handleHideShow(postsPage.hasNext, 'nextPage');
            })
            .catch(err => console.log(err));
        }

        function generatePosts(currentPagePostsData) {
            const postsContainer = document.querySelector('#postsWrapper');
            
            postsContainer.innerHTML = '';
            currentPagePostsData.forEach(postData => {
                const post = document.createElement('div');
                
                post.setAttribute('class', 'post');
                post.setAttribute('id', `post${postData.id}`);
                post.innerHTML = `
                    <h3>
                        <a href="/profile/${postData.poster.id}">${postData.poster.username}</a> says
                    </h3>
                    <p>${postData.content}</p>
                    <em>${postData.timestamp}</em>
                    <br>
                `;
                
                if (isUserAuthenticated) {
                    const likeIcon = generateLikeIcon(postData);
                    post.append(likeIcon);

                    // add the event handler when the like icon is available
                    observeElementResolveWhenAvailable(`#likeIcon${postData.id}`)
                    .then(likeIcon => likeIcon.onclick = () => handleLikeDislike(postData))
                    .catch(err => console.log(err));
                }

                post.innerHTML += `
                    <strong class="numLikes">${postData.number_likes}</strong>
                    <br>
                `;

                postsContainer.append(post);
            });
        }

        function generateLikeIcon(postData) {
            let likeIcon = document.createElement('img');

            likeIcon.setAttribute('class', 'likeIcon');
            likeIcon.setAttribute('id', `likeIcon${postData.id}`);
            
            if (postData.does_current_visitor_like_this_post) {
                likeIcon.setAttribute('src', '{% static "network/icons/heart-solid.png" %}');
            } else {
                likeIcon.setAttribute('src', '{% static "network/icons/heart-regular.png" %}');
            }
            
            return likeIcon;
        }

        function observeElementResolveWhenAvailable(selector) {
            return new Promise((resolve, reject) => {
                const observer = new MutationObserver(function(mutationsList, observer) {
                    const element = document.querySelector(selector);
                    
                    // verify if the element is available
                    if (element) {
                        observer.disconnect();
                        resolve(element);
                    }
                });

                // the observer is going to watch for document changes
                const targetNode = document;
                const config = { childList: true, subtree: true };

                observer.observe(targetNode, config); 
            });
        }

        function handleLikeDislike(postData) {            
            if (postData.does_current_visitor_like_this_post) {
                // dislike
                postData.number_likes--;
            } else {
                // like
                postData.number_likes++;
            }
            
            postData.does_current_visitor_like_this_post = ! postData.does_current_visitor_like_this_post;

            fetch(`/handleLikeDislike/${postData.id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    does_current_visitor_like_this_post: postData.does_current_visitor_like_this_post,
                    number_likes: postData.number_likes
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                const post = document.querySelector(`#post${data.id}`);

                post.querySelector('.numLikes').innerHTML = data.number_likes;

                const likeIcon = post.querySelector(`#likeIcon${data.id}`);

                if (postData.does_current_visitor_like_this_post) {
                    likeIcon.setAttribute('src', '{% static "network/icons/heart-solid.png" %}');
                } else {
                    likeIcon.setAttribute('src', '{% static "network/icons/heart-regular.png" %}');
                }
            })
            .catch(err => console.log(err));
        }

        function getCookie(name) {
			if (document.cookie && document.cookie !== '') {
				var cookies = document.cookie.split(';');

				for (let i = 0; i < cookies.length; i++) {
					let cookie = cookies[i].trim();
					// Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		            	var cookieValue = null;
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
				}
			}
			return cookieValue;
		}

        function handleHideShow(hasThisPage, pageId) {
            const page = document.querySelector(`#${pageId}`);
            
            if (hasThisPage)
                page.style.display = 'block';
            else
                page.style.display = 'none'
        }

        function handlePaginationByNumbers() {
            const pageNumber = this.innerHTML;
            navigateTo(pageNumber);

            deactivateAllPageItems('.page-item');
            markAsActive(currentNavigationPage);
        }

        function navigateTo(pageNumber) {
            fetchPostsPage(pageNumber);
            currentNavigationPage = pageNumber;
        }

        function deactivateAllPageItems(className) {
            const pageItems = document.querySelectorAll(className);
            
            pageItems.forEach(item => {
                item.classList.remove('active');
            });
        }
    </script>
{% endblock%}

{% block body %}
    {% if user.is_authenticated %}
        <form action="{% url 'index' %}" method="POST" class="newPostArea">
            {% csrf_token %}

            {{ new_post_form }}

            <button id="submitNewPost" class="btn btn-primary" button>Post</button>
        </form>
    {% endif %}

    <div class="postsContainer">
        <h2>Latest posts:</h2>

        <div id="postsWrapper">
            <!-- Posts from AJAX will be generated here -->
        </div>
        
        <nav aria-label="Page navigation example">
          <ul class="pagination">
            <li class="page-item">
                <button id="previousPage" class="page-link">Previous</button>
            </li>
            
            {% for i in page_range %}
                <li class="page-item">
                    <button class="page-link page-number">{{ forloop.counter }}</button>
                </li>
            {% endfor %}
            
            <li class="page-item">
                <button id="nextPage" class="page-link">Next</button>
            </li>
          </ul>
        </nav>
    </div>
{% endblock %}
